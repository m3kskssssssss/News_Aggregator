<!-- templates/index.html - ПОЛНАЯ ВЕРСИЯ -->
{% extends "base.html" %}

{% block title %}Главная - Новостной Агрегатор{% endblock %}

{% block content %}
<!-- Поиск по новостям -->
<div class="search-container">
    <form method="get" action="{{ url_for('index') }}" class="search-form">
        <input 
            type="text" 
            name="q" 
            placeholder="Поиск новостей..." 
            value="{{ q or '' }}" 
            class="search-input"
        >
        <button type="submit" class="search-btn">
            <i class="fas fa-search"></i>
        </button>
    </form>
</div>

{% if q %}
<div class="search-results-info">
    {% if articles.total > 0 %}
        Найдено <strong>{{ articles.total }}</strong> новостей по запросу «<strong>{{ q }}</strong>»
    {% else %}
        Ничего не найдено по запросу «<strong>{{ q }}</strong>»
    {% endif %}
</div>
{% endif %}

{% if current_user.is_authenticated %}
<!-- Кнопка для вызова выжимки -->
<div class="summary-button-container">
    <button id="generateSummary" class="summary-btn">
        <i class="fas fa-magic"></i>
        <span>Краткая выжимка</span>
    </button>
</div>

<!-- Модальное окно выбора темы -->
<div id="topicSelectionModal" class="topic-selection-modal">
    <div class="topic-modal-overlay"></div>
    <div class="topic-modal-content">
        <div class="topic-modal-header">
            <h2>
                <i class="fas fa-filter"></i>
                Выберите тему
            </h2>
            <button id="closeTopicModal" class="topic-close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="topic-modal-body">
            <div class="topic-description">
                <p>Выжимка по каким новостям вам нужна? Выберите интересующую тему:</p>
            </div>

            <div class="topics-grid">
                <div class="topic-card" data-topic="politics">
                    <span class="topic-icon"><i class="fas fa-balance-scale"></i></span>
                    <p class="topic-name">Политика</p>
                </div>

                <div class="topic-card" data-topic="technology">
                    <span class="topic-icon"><i class="fas fa-laptop-code"></i></span>
                    <p class="topic-name">Технологии</p>
                </div>

                <div class="topic-card" data-topic="economy">
                    <span class="topic-icon"><i class="fas fa-chart-line"></i></span>
                    <p class="topic-name">Экономика</p>
                </div>

                <div class="topic-card" data-topic="sports">
                    <span class="topic-icon"><i class="fas fa-futbol"></i></span>
                    <p class="topic-name">Спорт</p>
                </div>

                <div class="topic-card" data-topic="culture">
                    <span class="topic-icon"><i class="fas fa-theater-masks"></i></span>
                    <p class="topic-name">Культура</p>
                </div>

                <div class="topic-card" data-topic="science">
                    <span class="topic-icon"><i class="fas fa-flask"></i></span>
                    <p class="topic-name">Наука</p>
                </div>

                <div class="topic-card" data-topic="world">
                    <span class="topic-icon"><i class="fas fa-globe-americas"></i></span>
                    <p class="topic-name">Международные</p>
                </div>

                <div class="topic-card" data-topic="society">
                    <span class="topic-icon"><i class="fas fa-users"></i></span>
                    <p class="topic-name">Общество</p>
                </div>

                <div class="topic-card" data-topic="incidents">
                    <span class="topic-icon"><i class="fas fa-exclamation-triangle"></i></span>
                    <p class="topic-name">Происшествия</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для отображения результатов выжимки -->
<div id="summaryModal" class="summary-modal">
    <div class="summary-modal-overlay"></div>
    <div class="summary-modal-content">
        <!-- Контент будет заполнен через JavaScript -->
    </div>
</div>
{% endif %}

<div class="news-grid">
    {% for article in articles.items %}
    <article class="news-card modern-card">
        {% if article.url_to_image %}
        <div class="news-image">
            <img src="{{ article.url_to_image }}" alt="{{ article.title }}" loading="lazy">
            <div class="image-overlay">
                <span class="source-badge">{{ article.source.name }}</span>
            </div>
        </div>
        {% else %}
        <div class="news-image news-image-placeholder gradient-bg-{{ loop.index0 % 5 }}">
            <div class="placeholder-icon">
                <i class="fas fa-newspaper"></i>
            </div>
            <div class="image-overlay">
                <span class="source-badge">{{ article.source.name }}</span>
            </div>
        </div>
        {% endif %}

        <div class="news-content">
            <div class="news-meta">
                <span class="publish-date">
                    <i class="fas fa-clock"></i>
                    {{ article.published_at.strftime('%d.%m.%Y %H:%M') }}
                </span>
                <span class="category-badge">{{ article.source.category or 'Общее' }}</span>
            </div>

            <h2 class="news-title">
                <a href="{{ article.url }}" target="_blank" rel="noopener noreferrer">
                    {{ article.title }}
                </a>
            </h2>

            <p class="news-summary">
                {{ article.summary or article.description[:200] + '...' if article.description and article.description|length > 200 else article.description or '' }}
            </p>

            <div class="news-actions">
                <a href="{{ article.url }}" target="_blank" rel="noopener noreferrer" class="read-more-btn">
                    <i class="fas fa-external-link-alt"></i> Читать полностью
                </a>
                <div class="action-buttons">
                    <!-- Кнопка избранного -->
                    <button 
                        class="action-btn bookmark-btn {% if current_user.is_authenticated and current_user.is_favorite(article) %}active{% endif %}" 
                        title="В закладки" 
                        data-article-id="{{ article.id }}">
                        <i class="fas fa-bookmark"></i>
                    </button>

                    <!-- Кнопка поделиться -->
                    <button 
                        class="action-btn share-btn" 
                        title="Поделиться" 
                        data-url="{{ article.url }}">
                        <i class="fas fa-share-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </article>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-inbox"></i>
        <h3>Новостей не найдено</h3>
        {% if current_user.is_authenticated %}
        <p>Выберите источники новостей в настройках или дождитесь загрузки свежих новостей.</p>
        <a href="{{ url_for('settings') }}" class="btn btn-primary">
            <i class="fas fa-cog"></i> Настроить источники
        </a>
        {% else %}
        <p>В данный момент новости загружаются. Попробуйте обновить страницу через несколько минут.</p>
        <button onclick="window.location.reload()" class="btn btn-primary">
            <i class="fas fa-refresh"></i> Обновить страницу
        </button>
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- Пагинация -->
{% if articles.pages > 1 %}
<div class="pagination-wrapper">
    <nav class="pagination">
        {% if articles.has_prev %}
        <a href="{{ url_for('index', page=articles.prev_num) }}" class="pagination-btn">
            <i class="fas fa-chevron-left"></i> Предыдущая
        </a>
        {% endif %}

        <div class="pagination-info">
            Страница {{ articles.page }} из {{ articles.pages }}
        </div>

        {% if articles.has_next %}
        <a href="{{ url_for('index', page=articles.next_num) }}" class="pagination-btn">
            Следующая <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
    </nav>
</div>
{% endif %}

{% if current_user.is_authenticated %}
<!-- JavaScript для выжимки с выбором темы -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generateSummary');
    const topicModal = document.getElementById('topicSelectionModal');
    const summaryModal = document.getElementById('summaryModal');
    const topicCloseBtn = document.getElementById('closeTopicModal');
    const topicOverlay = document.querySelector('.topic-modal-overlay');
    const summaryOverlay = document.querySelector('.summary-modal-overlay');

    // Открытие модального окна выбора темы
    if (generateBtn) {
        generateBtn.addEventListener('click', function() {
            showTopicSelectionModal();
        });
    }

    // Закрытие модального окна выбора темы
    if (topicCloseBtn) {
        topicCloseBtn.addEventListener('click', closeTopicModal);
    }
    if (topicOverlay) {
        topicOverlay.addEventListener('click', closeTopicModal);
    }

    // Закрытие модального окна результатов
    if (summaryOverlay) {
        summaryOverlay.addEventListener('click', closeSummaryModal);
    }

    // Закрытие по Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeTopicModal();
            closeSummaryModal();
        }
    });

    // Обработчики для карточек тем
    const topicCards = document.querySelectorAll('.topic-card');
    topicCards.forEach(card => {
        card.addEventListener('click', function() {
            const topic = this.dataset.topic;
            const topicName = this.querySelector('.topic-name').textContent;
            generateSummaryForTopic(topic, topicName);
        });
    });
});

// Показать модальное окно выбора темы
function showTopicSelectionModal() {
    const modal = document.getElementById('topicSelectionModal');
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
}

// Закрыть модальное окно выбора темы
function closeTopicModal() {
    const modal = document.getElementById('topicSelectionModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

// Закрыть модальное окно результатов
function closeSummaryModal() {
    const modal = document.getElementById('summaryModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

// Генерация выжимки для выбранной темы
async function generateSummaryForTopic(topic, topicName) {
    console.log('Генерация выжимки для темы:', topic, topicName);
    
    // Закрываем окно выбора темы
    closeTopicModal();
    
    // Показываем загрузку
    showLoadingModal(topicName);
    
    try {
        const response = await fetch(`/api/news-summary?topic=${encodeURIComponent(topic)}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const result = await response.json();

        if (result.success) {
            if (result.data.top_articles && result.data.top_articles.length > 0) {
                showSummaryModal(result.data, topicName);
            } else {
                showEmptySummaryModal(topicName);
            }
        } else {
            closeSummaryModal();
            alert('Ошибка: ' + (result.error || 'Не удалось создать выжимку'));
        }
    } catch (error) {
        closeSummaryModal();
        console.error('Ошибка при получении выжимки:', error);
        alert('Не удалось создать выжимку. Попробуйте позже.');
    }
}

// Показать окно загрузки
function showLoadingModal(topicName) {
    const modal = document.getElementById('summaryModal');
    if (!modal) return;

    const modalContent = modal.querySelector('.summary-modal-content');
    modalContent.innerHTML = `
        <div class="summary-modal-header">
            <h2>
                <i class="fas fa-spinner fa-pulse"></i>
                Генерируем выжимку
            </h2>
        </div>
        <div class="summary-modal-body">
            <div class="summary-empty-state">
                <i class="fas fa-cog fa-spin"></i>
                <h3>Анализируем новости по теме "${topicName}"</h3>
                <p>Пожалуйста, подождите...</p>
            </div>
        </div>
    `;
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

// Показать пустой результат
function showEmptySummaryModal(topicName) {
    const modal = document.getElementById('summaryModal');
    if (!modal) return;

    const modalContent = modal.querySelector('.summary-modal-content');
    modalContent.innerHTML = `
        <div class="summary-modal-header">
            <h2>
                <i class="fas fa-newspaper"></i>
                Выжимка новостей
                <span class="summary-topic-badge">${topicName}</span>
            </h2>
            <button id="closeSummaryEmpty" class="summary-close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="summary-modal-body">
            <div class="summary-empty-state">
                <i class="fas fa-inbox"></i>
                <h3>Новости не найдены</h3>
                <p>Из ваших избранных источников не найдены новости по теме "${topicName}".<br>
                Попробуйте выбрать другую тему или добавьте больше источников в настройках.</p>
            </div>
        </div>
    `;
    
    // Добавляем обработчик для кнопки закрытия
    const closeBtn = document.getElementById('closeSummaryEmpty');
    if (closeBtn) {
        closeBtn.addEventListener('click', closeSummaryModal);
    }
    
    modal.style.display = 'flex';
}

// Показать результаты выжимки
function showSummaryModal(data, topicName) {
    console.log('Показываем результаты выжимки:', data);

    const modal = document.getElementById('summaryModal');
    if (!modal) {
        alert('Модальное окно не найдено');
        return;
    }

    // Формируем HTML для статей
    let articlesHTML = '';
    if (data.top_articles && data.top_articles.length > 0) {
        data.top_articles.forEach((article, index) => {
            articlesHTML += `
                <div class="summary-article-item">
                    <div class="summary-article-number">${index + 1}</div>
                    <div class="summary-article-content">
                        <h4><a href="${article.url}" target="_blank">${article.title}</a></h4>
                        <div class="summary-article-meta">
                            <span class="summary-article-source">
                                <i class="fas fa-newspaper"></i> ${article.source}
                            </span>
                            <span class="summary-article-time">
                                <i class="far fa-clock"></i>
                                ${new Date(article.published_at).toLocaleString('ru-RU')}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    // Обновляем содержимое модального окна
    const modalContent = modal.querySelector('.summary-modal-content');
    modalContent.innerHTML = `
        <div class="summary-modal-header">
            <h2>
                <i class="fas fa-newspaper"></i>
                Выжимка новостей
                <span class="summary-topic-badge">${topicName}</span>
            </h2>
            <button id="closeSummaryResult" class="summary-close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="summary-modal-body">
            <div class="summary-text">
                <p>${data.summary}</p>
            </div>
            
            <div class="summary-articles">
                <h3>
                    <i class="fas fa-list"></i>
                    Топ новостей по теме
                </h3>
                <div class="summary-articles-list">
                    ${articlesHTML}
                </div>
            </div>
            
            <div class="summary-meta">
                <div class="summary-stats">
                    <span>
                        <i class="far fa-calendar"></i>
                        ${data.generated_at}
                    </span>
                    <span>
                        <i class="fas fa-newspaper"></i>
                        Источников: ${data.total_sources || 0}
                    </span>
                    <span>
                        <i class="fas fa-file-alt"></i>
                        Статей: ${data.top_articles ? data.top_articles.length : 0}
                    </span>
                </div>
            </div>
        </div>
    `;

    // Добавляем обработчик для новой кнопки закрытия
    const closeBtn = document.getElementById('closeSummaryResult');
    if (closeBtn) {
        closeBtn.addEventListener('click', closeSummaryModal);
    }

    // Показываем модальное окно
    modal.style.display = 'flex';
}
</script>
{% endif %}

<!-- JS для избранного и кнопки поделиться -->
{% if current_user.is_authenticated %}
<script>
document.querySelectorAll(".bookmark-btn").forEach(btn => {
    btn.addEventListener("click", function () {
        const articleId = this.dataset.articleId;
        fetch(`/favorite/toggle/${articleId}`, {
            method: "POST",
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "added") {
                this.classList.add("active");
            } else {
                this.classList.remove("active");
            }
        })
        .catch(err => console.error("Ошибка:", err));
    });
});
</script>
{% endif %}

<script>
document.querySelectorAll(".share-btn").forEach(btn => {
    btn.addEventListener("click", function () {
        const url = this.dataset.url;
        if (navigator.share) {
            navigator.share({
                title: document.title,
                url: url
            }).catch(err => console.log("Ошибка:", err));
        } else {
            const shareText = `Поделиться ссылкой: ${url}`;
            prompt("Скопируйте ссылку и поделитесь:", shareText);
        }
    });
});
</script>
{% endblock %}