{% extends "base.html" %}

{% block title %}Главная - Новостной Агрегатор{% endblock %}

{% block content %}
{% if current_user.is_authenticated %}
<div class="summary-button-container">
    <button id="generateSummary" class="summary-btn">
        <i class="fas fa-list-alt"></i>
        <span>Краткая выжимка</span>
        <div class="summary-loader" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i>
        </div>
    </button>
</div>

<!-- JavaScript для выжимки -->
{% if current_user.is_authenticated %}
<script>
// Обработчик для краткой выжимки
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generateSummary');
    if (!generateBtn) {
        console.log('Кнопка generateSummary не найдена');
        return;
    }

    generateBtn.addEventListener('click', async function() {
        console.log('Кнопка нажата!');

        const btn = this;
        const loader = btn.querySelector('.summary-loader');
        const text = btn.querySelector('span');

        // Показываем загрузку
        btn.disabled = true;
        if (loader) loader.style.display = 'inline-block';
        if (text) text.textContent = 'Генерируем...';

        try {
            console.log('Отправляем запрос...');
            const response = await fetch('/api/news-summary', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            console.log('Получен ответ:', response.status);
            const result = await response.json();
            console.log('Данные:', result);

            if (result.success) {
                showSummaryModal(result.data);
            } else {
                alert('Ошибка: ' + (result.error || 'Не удалось создать выжимку'));
            }
        } catch (error) {
            console.error('Ошибка при получении выжимки:', error);
            alert('Не удалось создать выжимку: ' + error.message);
        } finally {
            // Скрываем загрузку
            btn.disabled = false;
            if (loader) loader.style.display = 'none';
            if (text) text.textContent = 'Краткая выжимка';
        }
    });
});

// Функция показа модального окна
function showSummaryModal(data) {
    console.log('Показываем модальное окно:', data);

    const modal = document.getElementById('summaryModal');
    if (!modal) {
        alert('Модальное окно не найдено');
        return;
    }

    const summaryText = modal.querySelector('.summary-text');
    const articlesList = modal.querySelector('.summary-articles-list');
    const summaryMeta = modal.querySelector('.summary-meta');

    // Заполняем текст выжимки
    if (summaryText) {
        summaryText.innerHTML = `<p>${data.summary}</p>`;
    }

    // Заполняем список статей
    if (articlesList && data.top_articles) {
        articlesList.innerHTML = '';
        data.top_articles.forEach((article, index) => {
            const articleElement = document.createElement('div');
            articleElement.className = 'summary-article-item';
            articleElement.innerHTML = `
                <div class="summary-article-number">${index + 1}</div>
                <div class="summary-article-content">
                    <h4><a href="${article.url}" target="_blank">${article.title}</a></h4>
                    <div class="summary-article-meta">
                        <span class="summary-article-source">${article.source}</span>
                        <span class="summary-article-time">${new Date(article.published_at).toLocaleString('ru-RU')}</span>
                    </div>
                </div>
            `;
            articlesList.appendChild(articleElement);
        });
    }

    // Метаинформация
    if (summaryMeta) {
        summaryMeta.innerHTML = `
            <div class="summary-stats">
                <span>Создано: ${data.generated_at}</span>
                <span>Источников: ${data.total_sources || 0}</span>
                <span>Статей: ${data.top_articles ? data.top_articles.length : 0}</span>
            </div>
        `;
    }

    // Показываем модальное окно
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

// Закрытие модального окна
document.addEventListener('DOMContentLoaded', function() {
    const closeBtn = document.getElementById('closeSummary');
    const overlay = document.querySelector('.summary-modal-overlay');

    if (closeBtn) {
        closeBtn.addEventListener('click', closeSummaryModal);
    }
    if (overlay) {
        overlay.addEventListener('click', closeSummaryModal);
    }

    // Закрытие по Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeSummaryModal();
        }
    });
});

function closeSummaryModal() {
    const modal = document.getElementById('summaryModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}
</script>
{% endif %}
{% endif %}

<div class="news-grid">
    {% for article in articles.items %}
    <article class="news-card modern-card">
        {% if article.url_to_image %}
        <div class="news-image">
            <img src="{{ article.url_to_image }}" alt="{{ article.title }}" loading="lazy">
            <div class="image-overlay">
                <span class="source-badge">{{ article.source.name }}</span>
            </div>
        </div>
        {% else %}
        <div class="news-image news-image-placeholder gradient-bg-{{ loop.index0 % 5 }}">
            <div class="placeholder-icon">
                <i class="fas fa-newspaper"></i>
            </div>
            <div class="image-overlay">
                <span class="source-badge">{{ article.source.name }}</span>
            </div>
        </div>
        {% endif %}

        <div class="news-content">
            <div class="news-meta">
                <span class="publish-date">
                    <i class="fas fa-clock"></i>
                    {{ article.published_at.strftime('%d.%m.%Y %H:%M') }}
                </span>
                <span class="category-badge">{{ article.source.category or 'Общее' }}</span>
            </div>

            <h2 class="news-title">
                <a href="{{ article.url }}" target="_blank" rel="noopener noreferrer">
                    {{ article.title }}
                </a>
            </h2>

            <p class="news-summary">
                {{ article.summary or article.description[:200] + '...' if article.description and article.description|length > 200 else article.description or '' }}
            </p>

            <div class="news-actions">
                <a href="{{ article.url }}" target="_blank" rel="noopener noreferrer" class="read-more-btn">
                    <i class="fas fa-external-link-alt"></i> Читать полностью
                </a>
                <div class="action-buttons">
                    <!-- Кнопка избранного -->
                    <button 
                        class="action-btn bookmark-btn {% if current_user.is_authenticated and current_user.is_favorite(article) %}active{% endif %}" 
                        title="В закладки" 
                        data-article-id="{{ article.id }}">
                        <i class="fas fa-bookmark"></i>
                    </button>

                    <!-- Кнопка поделиться -->
                    <button 
                        class="action-btn share-btn" 
                        title="Поделиться" 
                        data-url="{{ article.url }}">
                        <i class="fas fa-share-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </article>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-inbox"></i>
        <h3>Новостей не найдено</h3>
        {% if current_user.is_authenticated %}
        <p>Выберите источники новостей в настройках или дождитесь загрузки свежих новостей.</p>
        <a href="{{ url_for('settings') }}" class="btn btn-primary">
            <i class="fas fa-cog"></i> Настроить источники
        </a>
        {% else %}
        <p>В данный момент новости загружаются. Попробуйте обновить страницу через несколько минут.</p>
        <button onclick="window.location.reload()" class="btn btn-primary">
            <i class="fas fa-refresh"></i> Обновить страницу
        </button>
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- Пагинация -->
{% if articles.pages > 1 %}
<div class="pagination-wrapper">
    <nav class="pagination">
        {% if articles.has_prev %}
        <a href="{{ url_for('index', page=articles.prev_num) }}" class="pagination-btn">
            <i class="fas fa-chevron-left"></i> Предыдущая
        </a>
        {% endif %}

        <div class="pagination-info">
            Страница {{ articles.page }} из {{ articles.pages }}
        </div>

        {% if articles.has_next %}
        <a href="{{ url_for('index', page=articles.next_num) }}" class="pagination-btn">
            Следующая <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
    </nav>
</div>
{% endif %}
<!-- Модальное окно для выжимки -->
{% if current_user.is_authenticated %}
<div id="summaryModal" class="summary-modal">
    <div class="summary-modal-overlay"></div>
    <div class="summary-modal-content">
        <div class="summary-modal-header">
            <h2>Краткая выжимка новостей</h2>
            <button id="closeSummary" class="summary-close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="summary-modal-body">


            <div class="summary-articles">
                <h3>Топ новостей:</h3>
                <div class="summary-articles-list">
                    <!-- Здесь будет список статей -->
                </div>
            </div>

            <div class="summary-meta">
                <!-- Метаинформация о выжимке -->
            </div>
        </div>
    </div>
</div>
{% endif %}
<!-- JS для избранного и кнопки поделиться -->
{% if current_user.is_authenticated %}
<script>
document.querySelectorAll(".bookmark-btn").forEach(btn => {
    btn.addEventListener("click", function () {
        const articleId = this.dataset.articleId;
        fetch(`/favorite/toggle/${articleId}`, {
            method: "POST",
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "added") {
                this.classList.add("active");
            } else {
                this.classList.remove("active");
            }
        })
        .catch(err => console.error("Ошибка:", err));
    });
});
</script>
{% endif %}

<script>
document.querySelectorAll(".share-btn").forEach(btn => {
    btn.addEventListener("click", function () {
        const url = this.dataset.url;
        if (navigator.share) {
            navigator.share({
                title: document.title,
                url: url
            }).catch(err => console.log("Ошибка:", err));
        } else {
            // fallback для ПК
            const shareText = `Поделиться ссылкой: ${url}`;
            prompt("Скопируйте ссылку и поделитесь:", shareText);
        }
    });
});
</script>
{% endblock %}
